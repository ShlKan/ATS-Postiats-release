os:
  - osx
  - linux
sudo: false
language: c
compiler:
  - gcc
  - clang 
env:
  global:
    # ATS1
    - ATSVER=0.2.12
    - ATSHOME=${HOME}/ats-lang-anairiats-${ATSVER}
    - ATSHOMERELOC=ATS-${ATSVER}
    # ATS2
    - PATSHOME=${TRAVIS_BUILD_DIR}
    - PATSHOMERELOC=${HOME}/ATS-Postiats-contrib
    - PATSHOME_contrib=${PATSHOMERELOC}
    # Path
    - PATH=${PATH}:${PATSHOME}/bin
addons:
  apt:
    packages:
    - libgc-dev
    - libgmp-dev
    - libgtk-3-dev
    - libev-dev
    - libjson0-dev
    - libjansson-dev
    - docbook-utils
before_install:
  # Install OSX Packages
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then ${TRAVIS_BUILD_DIR}/travis-ci/install_osx.sh; fi
install:
  - date
  - cd ${HOME}
  # Build ATS1
  - echo -e "\033[1m[93mBuilding ATS1 ...[0m"
  - ${TRAVIS_BUILD_DIR}/travis-ci/install_ats1.sh
script:
  # Building ATS2
  - echo -e "\033[1m[93mBuilding ATS2 ...[0m"
  - ${CC} --version
  - cd ${PATSHOME}
  - make -f Makefile_devl CC=${GCC} all
  # make GCFLAG=-D_ATS_GCATS -f Makefile_devl CC=${GCC} all
  # make C3NSTRINTKND=intknd -f Makefile_devl CC=${CLANG} all
  # make C3NSTRINTKND=intknd GCFLAG=-D_ATS_GCATS -f Makefile_devl CC=${CLANG} all
  # Trying-out release process
  - echo -e "\033[1m[93mBuilding CBOOT and DISTRIB ...[0m"
  - cd ${PATSHOME}
  - make -C ${PATSHOME}/src CBOOT
  - make -C ${PATSHOME}/src/CBOOT/prelude
  - make -C ${PATSHOME}/src/CBOOT/libc
  - make -C ${PATSHOME}/src/CBOOT/libats
  - make -C ${PATSHOME}/doc/DISTRIB atspackaging
  - make -C ${PATSHOME}/doc/DISTRIB atspacktarzvcf
  - make -C ${PATSHOME}/doc/DISTRIB cleanall
  # make -C ${PATSHOME}/doc/DISTRIB atscontribing
  # make -C ${PATSHOME}/doc/DISTRIB atscntrbtarzvcf
  # make -C ${PATSHOME}/doc/DISTRIB cleanall
  # 
  # Running regress test
  - echo -e "\033[1m[93mRegression tests ...[0m"
  - cd ${PATSHOME}
  - make -C ${PATSHOME}/doc -f Makefile_test testall > testall_doc.log 2>&1
  - tail -100 testall_doc.log
  # Building some utilities
  - echo -e "\033[1m[93mBuidling utilities ...[0m"
  - cd ${PATSHOME}
  - cp ${ATSHOME}/config.h .
  - make -C src cleanall
  - make -C src/CBOOT/prelude
  - make -C src/CBOOT/libc
  - make -C src/CBOOT/libats
  - make -C utils/libatsopt
  - cp utils/libatsopt/libatsopt.a ${ATSHOME}/ccomp/lib
  - make -C utils/libatsynmark
  - cp utils/libatsynmark/libatsynmark.a ${ATSHOME}/ccomp/lib
  - make -C utils/atsynmark
  # make -C utils/atstagging
  # make -C utils/packeditall
  # 
  # Install Contrib
  - echo -e "\033[1m[93mInstalling ATS2-Contrib ...[0m"
  - cd ${HOME}
  - git clone https://github.com/githwxi/ATS-Postiats-contrib.git ATS-Postiats-contrib
  # Building books
  - echo -e "\033[1m[93mBuilding books ...[0m"
  - cd ${PATSHOME}
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then make -C doc/BOOK/ATS2TUTORIAL; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then make -C doc/BOOK/INT2PROGINATS; fi
after_script:
  - date
